AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: >
  Iris MVP - application stack (Lambda functions + wiring).

Parameters:
  Stage:
    Type: String
    Default: prod
    AllowedValues:
      - prod
  InfraStackName:
    Type: String
    Default: iris-infra-prod
  ReminderDelaySeconds:
    Type: Number
    Default: 7200
  ContactToEmail:
    Type: String
  ContactFromEmail:
    Type: String
  AllowedOrigins:
    Type: String
    Default: ""
  SesRegion:
    Type: String
    Default: us-east-1
  ContactApiId:
    Type: String

Globals:
  Function:
    Runtime: python3.12
    Architectures:
      - arm64
    MemorySize: 256
    Timeout: 20
    Tracing: Active
    Tags:
      Stage: !Ref Stage

Resources:
  IrisInviteFunction:
    Type: AWS::Serverless::Function
    Properties:
      # Preserve existing physical name during import.
      FunctionName: iris-prod-IrisInviteFunction-mWTN1LXzwlBP
      CodeUri: src/
      Handler: app.lambda_handler
      Role: !ImportValue
        'Fn::Sub': '${InfraStackName}-InviteFunctionRoleArn'

      EphemeralStorage:
        Size: 512

      Environment:
        Variables:
          BUCKET_NAME: !ImportValue
            'Fn::Sub': '${InfraStackName}-RawEmailBucketName'
          TABLE_NAME: !ImportValue
            'Fn::Sub': '${InfraStackName}-ThreadsTableName'
          SCHEDULER_ROLE_ARN: !ImportValue
            'Fn::Sub': '${InfraStackName}-SchedulerInvokeRoleArn'
          SCHEDULER_GROUP_NAME: !ImportValue
            'Fn::Sub': '${InfraStackName}-ReminderScheduleGroupName'
          REMINDER_DELAY_SECONDS: !Ref ReminderDelaySeconds
          REMINDER_LAMBDA_ARN: !GetAtt IrisReminderFunction.Arn
          GOOGLE_OAUTH_SECRET_NAME: liazon/iris/google_oauth
          AI_REASONING_MODE: 'true'
          IRIS_EMAIL: iris@liazon.cc
          TIMEZONE: America/New_York
          BEDROCK_GUARDRAIL_ID: 4us43pe9ntte
          BEDROCK_GUARDRAIL_VERSION: DRAFT
          BEDROCK_REGION: us-east-1

  # Allow SES receipt rules to invoke this Lambda.
  # NOTE: This does not create SES rules; it only permits invocation from the existing rule ARN.
  AllowSesInvokeLambdaFromReceiptRule:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref IrisInviteFunction
      Principal: ses.amazonaws.com
      SourceAccount: !Ref AWS::AccountId
      SourceArn: !Sub arn:aws:ses:${AWS::Region}:${AWS::AccountId}:receipt-rule-set/iris-${Stage}:receipt-rule/iris-inbound

  IrisReminderFunction:
    Type: AWS::Serverless::Function
    Properties:
      # Stack-managed name; ensures GitHub Actions / SAM deployments own this Lambda.
      FunctionName: liazon-reminder-handler
      CodeUri: src/
      Handler: iris.entrypoints.reminder_handler.lambda_handler
      Role: !ImportValue
        'Fn::Sub': '${InfraStackName}-ReminderFunctionRoleArn'

      EphemeralStorage:
        Size: 512

      Environment:
        Variables:
          THREADS_TABLE: !ImportValue
            'Fn::Sub': '${InfraStackName}-ThreadsTableName'
          IRIS_EMAIL: iris@liazon.cc
          TIMEZONE: America/New_York
          REMINDER_DELAY_SECONDS: !Ref ReminderDelaySeconds

  ContactFormSendFunction:
    Type: AWS::Serverless::Function
    Properties:
      # Stack-managed name; ensures GitHub Actions / SAM deployments own this Lambda.
      FunctionName: contact-form-send-prod
      CodeUri: src/
      Handler: iris.entrypoints.contact_form_send.lambda_handler
      Role: !ImportValue
        'Fn::Sub': '${InfraStackName}-ContactFormSendFunctionRoleArn'

      Environment:
        Variables:
          SES_REGION: !Ref SesRegion
          CONTACT_TO_EMAIL: !Ref ContactToEmail
          CONTACT_FROM_EMAIL: !Ref ContactFromEmail
          ALLOWED_ORIGINS: !Ref AllowedOrigins

  ContactFormSendPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref ContactFormSendFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ContactApiId}/*/POST/contact

  ContactFormSendIntegration:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId: !Ref ContactApiId
      IntegrationType: AWS_PROXY
      IntegrationMethod: POST
      PayloadFormatVersion: '2.0'
      TimeoutInMillis: 20000
      IntegrationUri: !Sub arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${ContactFormSendFunction.Arn}/invocations

  ContactFormSendRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref ContactApiId
      RouteKey: POST /contact
      AuthorizationType: NONE
      Target: !Sub integrations/${ContactFormSendIntegration}

Outputs:
  InviteFunctionName:
    Value: !Ref IrisInviteFunction
  InviteFunctionArn:
    Value: !GetAtt IrisInviteFunction.Arn

  ReminderFunctionName:
    Value: !Ref IrisReminderFunction
  ReminderFunctionArn:
    Value: !GetAtt IrisReminderFunction.Arn

  ContactFormSendFunctionName:
    Value: !Ref ContactFormSendFunction
  ContactFormSendFunctionArn:
    Value: !GetAtt ContactFormSendFunction.Arn
